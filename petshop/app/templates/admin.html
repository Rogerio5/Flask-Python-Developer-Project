{% extends "base.html" %}
{% block title %}Painel Administrativo{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Painel Administrativo</h2>
    <a href="/logout" class="btn btn-outline-danger">Sair</a>
  </div>

  <!-- Formulário de busca -->
  <form id="form-data" class="mb-3">
    <div class="input-group">
      <input type="date" id="data" class="form-control" required>
      <button class="btn btn-primary" type="submit">Buscar</button>
    </div>
  </form>

  <!-- Tabela de reservas -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="tabela-reservas">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Data</th>
          <th>Pet</th>
          <th>Cliente</th>
          <th>Telefone</th>
          <th>Categoria</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Mensagens -->
  <div id="mensagem" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function statusBadge(status) {
  const map = {
    agendado: "primary",
    concluido: "success",
    cancelado: "danger"
  };
  return `<span class="badge bg-${map[status] || "secondary"}">${status}</span>`;
}

async function carregarReservas(dia) {
  const resp = await fetch(`/api/reservas?data=${dia}`);
  const reservas = await resp.json();

  const tbody = document.querySelector("#tabela-reservas tbody");
  tbody.innerHTML = "";
  if (reservas.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Nenhuma reserva encontrada</td></tr>`;
    return;
  }

  reservas.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.id}</td>
        <td>${r.data}</td>
        <td>${r.pet_nome}</td>
        <td>${r.cliente ? r.cliente.nome : "-"}</td>
        <td>${r.cliente ? r.cliente.telefone : "-"}</td>
        <td>${r.categoria || "-"}</td>
        <td id="status-${r.id}">${statusBadge(r.status)}</td>
        <td>
          <button class="btn btn-success btn-sm me-1" onclick="atualizarStatus(${r.id}, 'concluido', this)">Concluir</button>
          <button class="btn btn-danger btn-sm" onclick="atualizarStatus(${r.id}, 'cancelado', this)">Cancelar</button>
        </td>
      </tr>
    `;
  });
}

async function atualizarStatus(id, status, btn) {
  const rowBtns = btn.parentElement.querySelectorAll("button");
  rowBtns.forEach(b => b.disabled = true);

  const resp = await fetch(`/api/reservas/${id}`, {
    method: "PATCH",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({status})
  });
  const data = await resp.json();
  const msg = document.getElementById("mensagem");

  if (resp.ok) {
    document.getElementById(`status-${id}`).innerHTML = statusBadge(data.status);
    msg.innerHTML = `<div class="alert alert-success">Reserva ${id} atualizada para ${data.status}</div>`;
  } else {
    msg.innerHTML = `<div class="alert alert-danger">Erro: ${data.message || "Falha ao atualizar"}</div>`;
  }

  rowBtns.forEach(b => b.disabled = false);
}

document.getElementById("form-data").addEventListener("submit", (e) => {
  e.preventDefault();
  const dia = document.getElementById("data").value;
  carregarReservas(dia);
});

document.addEventListener("DOMContentLoaded", () => {
  const hoje = new Date().toISOString().split("T")[0];
  document.getElementById("data").value = hoje;
  carregarReservas(hoje);
});
</script>
{% endblock %}
